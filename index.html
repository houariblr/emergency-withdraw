<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Withdraw Tool | Recover Your Crypto Funds</title>
    <meta name="description" content="Recover your funds from dead or disappeared DeFi projects. Simple interface to interact with smart contracts when the frontend is down.">
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f1117;
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .container { max-width: 820px; margin: 0 auto; }

        header {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, #1a1d29, #252836);
            border-radius: 16px;
            margin-bottom: 25px;
            border: 2px solid #ff4444;
        }

        h1 { font-size: 2rem; color: #ff4444; margin-bottom: 8px; font-weight: 700; }
        .subtitle { color: #b0b0b0; font-size: 1rem; }

        .card {
            background: #1a1d29;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid #2a2d39;
        }

        .card h2 { color: #00ffcc; font-size: 1.2rem; margin-bottom: 18px; }

        .warning-banner {
            background: #2a1818;
            border-left: 4px solid #ff4444;
            padding: 18px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .warning-banner h3 { color: #ff4444; margin-bottom: 10px; font-size: 1rem; }

        .warning-banner li {
            padding: 4px 0 4px 22px;
            position: relative;
            color: #ffaaaa;
            font-size: 0.88rem;
            list-style: none;
        }

        .warning-banner li:before { content: "‚ö†"; position: absolute; left: 0; }

        .speed-banner {
            background: linear-gradient(135deg, #1a1d29, #252836);
            border: 2px solid #00ffcc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .speed-icon { font-size: 2rem; }
        .speed-text h3 { color: #00ffcc; font-size: 1rem; margin-bottom: 4px; }
        .speed-text p { color: #b0b0b0; font-size: 0.85rem; }

        label { display: block; margin-bottom: 7px; color: #b0b0b0; font-size: 0.88rem; font-weight: 500; }

        input, select {
            width: 100%;
            padding: 12px 15px;
            background: #0f1117;
            border: 2px solid #2a2d39;
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 0.95rem;
            transition: border-color 0.3s, box-shadow 0.3s;
            margin-bottom: 15px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #00ffcc;
            box-shadow: 0 0 0 3px rgba(0, 255, 204, 0.1);
        }

        .btn {
            width: 100%;
            padding: 13px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 5px;
        }

        .btn-green {
            background: linear-gradient(135deg, #00ffcc, #00d9b3);
            color: #0f1117;
        }

        .btn-green:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,255,204,0.4);
        }

        .btn-red {
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: #fff;
        }

        .btn-red:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255,68,68,0.4);
        }

        .btn:disabled { opacity: 0.45; cursor: not-allowed; transform: none !important; }

        .wallet-box {
            background: #0f1117;
            border: 1px solid #00ffcc44;
            padding: 14px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }

        .wallet-box.show { display: block; }

        .wallet-box p {
            color: #00ffcc;
            font-size: 0.88rem;
            margin-bottom: 5px;
            word-break: break-all;
        }

        .wallet-box p:last-child { margin-bottom: 0; }

        .divider {
            text-align: center;
            color: #5a5a5a;
            margin: 20px 0;
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #00ffcc;
            display: none;
        }

        .loading.show { display: block; }

        .spinner {
            border: 3px solid #2a2d39;
            border-top: 3px solid #00ffcc;
            border-radius: 50%;
            width: 38px;
            height: 38px;
            animation: spin 0.9s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text { color: #b0b0b0; font-size: 0.9rem; margin-top: 8px; }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #2a2d39;
            border-radius: 2px;
            margin-top: 12px;
            overflow: hidden;
            display: none;
        }

        .progress-bar.show { display: block; }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ffcc, #00d9b3);
            border-radius: 2px;
            transition: width 0.3s;
            width: 0%;
        }

        .error-box {
            background: #2a1818;
            color: #ffaaaa;
            padding: 13px 15px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 0.88rem;
            display: none;
            border-left: 3px solid #ff4444;
        }

        .error-box.show { display: block; }

        .success-box {
            background: #182a18;
            color: #aaffaa;
            padding: 13px 15px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 0.88rem;
            display: none;
            border-left: 3px solid #00ff88;
        }

        .success-box.show { display: block; }

        /* Contracts List */
        .contracts-grid { display: flex; flex-direction: column; gap: 10px; }

        .contract-card {
            background: #0f1117;
            border: 1px solid #2a2d39;
            border-radius: 10px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.25s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .contract-card:hover {
            border-color: #00ffcc;
            background: #1a1d29;
            transform: translateX(4px);
        }

        .contract-left { flex: 1; }

        .contract-name {
            font-weight: 600;
            color: #e0e0e0;
            font-size: 0.95rem;
            margin-bottom: 4px;
        }

        .contract-addr {
            font-family: monospace;
            color: #8a8a8a;
            font-size: 0.8rem;
        }

        .contract-meta {
            display: flex;
            gap: 10px;
            margin-top: 6px;
            flex-wrap: wrap;
        }

        .meta-tag {
            background: #2a2d39;
            color: #b0b0b0;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .meta-tag.green { background: #00ffcc22; color: #00ffcc; }
        .meta-tag.red { background: #ff444422; color: #ff8888; }
        .meta-tag.orange { background: #ffa50022; color: #ffa500; }

        .contract-arrow { color: #00ffcc; font-size: 1.2rem; margin-left: 10px; }

        /* Functions */
        .function-card {
            background: #0f1117;
            border: 1px solid #2a2d39;
            border-left: 4px solid #00ffcc;
            border-radius: 8px;
            padding: 13px 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.25s;
        }

        .function-card:hover { background: #1a1d29; transform: translateX(4px); }
        .function-card.danger { border-left-color: #ff4444; }

        .function-title {
            font-weight: 600;
            color: #00ffcc;
            font-size: 0.95rem;
            margin-bottom: 3px;
            font-family: monospace;
        }

        .function-card.danger .function-title { color: #ff8888; }
        .function-desc { color: #b0b0b0; font-size: 0.82rem; }

        /* Fee box */
        .fee-box {
            background: #1a1800;
            border: 1px solid #ffa50055;
            padding: 14px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .fee-box h4 { color: #ffa500; margin-bottom: 6px; font-size: 0.95rem; }
        .fee-box p { color: #b0b0b0; font-size: 0.85rem; }

        /* TX Preview */
        .tx-preview {
            background: #0f1117;
            border: 1px solid #2a2d39;
            border-radius: 8px;
            padding: 14px;
            margin-bottom: 15px;
            display: none;
        }

        .tx-preview.show { display: block; }
        .tx-preview h4 { color: #00ffcc; margin-bottom: 10px; font-size: 0.95rem; }

        .tx-row {
            display: flex;
            justify-content: space-between;
            padding: 7px 0;
            border-bottom: 1px solid #2a2d39;
            font-size: 0.85rem;
        }

        .tx-row:last-child { border-bottom: none; }
        .tx-key { color: #8a8a8a; }
        .tx-val { color: #e0e0e0; font-weight: 600; font-family: monospace; }

        footer {
            text-align: center;
            padding: 30px 20px;
            color: #6a6a6a;
            font-size: 0.85rem;
        }

        @media (max-width: 600px) {
            h1 { font-size: 1.5rem; }
            .card { padding: 18px; }
            .speed-banner { flex-direction: column; text-align: center; }
        }
    </style>
</head>
<body>
<div class="container">

    <header>
        <h1>üö® Emergency Withdraw Tool</h1>
        <p class="subtitle">Recover your locked funds when DeFi project websites disappear</p>
    </header>

    <!-- Security Notice -->
    <div class="warning-banner">
        <h3>‚ö†Ô∏è Security Notice</h3>
        <ul>
            <li>We NEVER ask for your private keys or seed phrase ‚Äî never share them with anyone</li>
            <li>You only connect your wallet (like MetaMask) to approve transactions yourself</li>
            <li>Always verify all transaction details in your wallet before confirming</li>
            <li>Use at your own risk ‚Äî we are not responsible for any losses</li>
            <li>Service fee: 0.005 BNB (~$3) is charged per withdrawal to support this tool</li>
        </ul>
    </div>

    <!-- Speed Banner -->
    <div class="speed-banner">
        <div class="speed-icon">‚ö°</div>
        <div class="speed-text">
            <h3>Fast Mode Active ‚Äî BSCScan API Connected</h3>
            <p>Your wallet will be scanned in 3‚Äì5 seconds with full contract details, names, and verification status</p>
        </div>
    </div>

    <!-- Step 1: Connect Wallet -->
    <div class="card">
        <h2>Step 1 ‚Äî Connect Your Wallet</h2>
        <button id="connectBtn" class="btn btn-green">üîó Connect Wallet</button>
        <div id="walletBox" class="wallet-box">
            <p><strong>Address:</strong> <span id="walletAddr">‚Äî</span></p>
            <p><strong>Network:</strong> <span id="networkName">‚Äî</span></p>
            <p><strong>Balance:</strong> <span id="walletBal">‚Äî</span></p>
        </div>
        <div id="connectError" class="error-box"></div>
    </div>

    <!-- Step 2: Find Contracts -->
    <div class="card">
        <h2>Step 2 ‚Äî Find Your Contracts</h2>

        <button id="scanBtn" class="btn btn-green" disabled>üîç Scan My Wallet (Auto)</button>
        <p style="color:#8a8a8a; font-size:0.82rem; text-align:center; margin-top:8px;">
            Automatically finds all smart contracts you've interacted with
        </p>

        <div class="divider">‚Äî OR enter manually ‚Äî</div>

        <label>Blockchain Network</label>
        <select id="networkSelect">
            <option value="bsc">Binance Smart Chain (BSC)</option>
            <option value="eth">Ethereum</option>
            <option value="polygon">Polygon</option>
        </select>

        <label>Contract Address</label>
        <input type="text" id="contractInput" placeholder="0x..." />

        <button id="analyzeBtn" class="btn btn-green" disabled>üîé Analyze Contract</button>

        <div id="scanLoading" class="loading">
            <div class="spinner"></div>
            <div id="scanLoadingText" class="loading-text">Scanning wallet...</div>
            <div class="progress-bar show"><div id="progressFill" class="progress-fill"></div></div>
        </div>

        <div id="scanError" class="error-box"></div>
    </div>

    <!-- Contracts List (shown after scan) -->
    <div id="contractsCard" class="card" style="display:none;">
        <h2>üìã Contracts Found ‚Äî Select One</h2>
        <p style="color:#b0b0b0; font-size:0.85rem; margin-bottom:15px;">
            Click any contract to analyze its withdrawal functions
        </p>
        <div id="contractsGrid" class="contracts-grid"></div>
    </div>

    <!-- Step 3: Functions -->
    <div id="functionsCard" class="card" style="display:none;">
        <h2>Step 3 ‚Äî Select Withdrawal Function</h2>
        <p style="color:#b0b0b0; font-size:0.85rem; margin-bottom:15px;">
            These functions were detected in the contract. Click one to proceed.
        </p>
        <div id="functionsList"></div>

        <div id="analyzeLoading" class="loading">
            <div class="spinner"></div>
            <div class="loading-text">Reading contract...</div>
        </div>

        <div id="analyzeError" class="error-box"></div>
    </div>

    <!-- Step 4: Execute -->
    <div id="executeCard" class="card" style="display:none;">
        <h2>Step 4 ‚Äî Execute Withdrawal</h2>

        <div class="fee-box">
            <h4>üí∞ Service Fee</h4>
            <p>A fee of <strong>0.005 BNB (~$3)</strong> will be sent to support this tool before your withdrawal is executed.</p>
        </div>

        <div id="txPreview" class="tx-preview">
            <h4>Transaction Preview</h4>
            <div class="tx-row">
                <span class="tx-key">Function</span>
                <span class="tx-val" id="prevFunc">‚Äî</span>
            </div>
            <div class="tx-row">
                <span class="tx-key">Contract</span>
                <span class="tx-val" id="prevContract">‚Äî</span>
            </div>
            <div class="tx-row">
                <span class="tx-key">Service Fee</span>
                <span class="tx-val">0.005 BNB</span>
            </div>
            <div class="tx-row">
                <span class="tx-key">Estimated Gas</span>
                <span class="tx-val" id="prevGas">Calculating...</span>
            </div>
        </div>

        <button id="executeBtn" class="btn btn-red">üöÄ Execute Withdrawal</button>

        <div id="execSuccess" class="success-box"></div>
        <div id="execError" class="error-box"></div>
    </div>

    <!-- How it works -->
    <div class="card">
        <h2>‚ùì How It Works</h2>
        <p style="color:#b0b0b0; line-height:1.85; font-size:0.9rem;">
            When a DeFi project disappears, your funds remain locked in its smart contract on the blockchain.
            This tool reads that contract directly and gives you a simple button to withdraw ‚Äî without needing the original website.<br><br>
            <strong>Steps:</strong><br>
            1. Connect your wallet (MetaMask / Trust Wallet)<br>
            2. Scan your wallet or paste the contract address<br>
            3. Select the withdrawal function<br>
            4. Confirm the transaction in your wallet<br><br>
            <strong style="color:#ff8888;">Important:</strong> Always double-check the contract address before proceeding. Never share your seed phrase with anyone.
        </p>
    </div>

</div>

<footer>
    <p>¬© 2026 Emergency Withdraw Tool | Built by Houari Boulares</p>
    <p style="margin-top:6px;">Educational purposes only. Not financial advice. Use at your own risk.</p>
</footer>

<script>
// ============================================================
//  CONFIGURATION ‚Äî DO NOT SHARE THIS FILE PUBLICLY
// ============================================================
const FEE_RECIPIENT  = '0x97c75674B4A64d690bd4B5714210fD87FB0370dC';
const SERVICE_FEE    = ethers.utils.parseEther('0.005');

const API_KEYS = {
    bscscan:    '9X7377VVGNKKWX71IZP8C7PARZNSQWAXRB',
    etherscan:  'YOUR_ETHERSCAN_KEY',   // optional ‚Äî get free at etherscan.io
    polygonscan:'YOUR_POLYGONSCAN_KEY'  // optional ‚Äî get free at polygonscan.com
};

const NETWORKS = {
    bsc: {
        chainId:  '0x38',
        name:     'BSC Mainnet',
        symbol:   'BNB',
        rpc:      'https://bsc-dataseed.binance.org/',
        explorer: 'https://bscscan.com',
        api:      'https://api.bscscan.com/api',
        apiKey:   'bscscan'
    },
    eth: {
        chainId:  '0x1',
        name:     'Ethereum Mainnet',
        symbol:   'ETH',
        rpc:      'https://eth-mainnet.g.alchemy.com/v2/-nlfxnEP1jvwjMZFHTgZT',
        explorer: 'https://etherscan.io',
        api:      'https://api.etherscan.io/api',
        apiKey:   'etherscan'
    },
    polygon: {
        chainId:  '0x89',
        name:     'Polygon Mainnet',
        symbol:   'MATIC',
        rpc:      'https://polygon-rpc.com',
        explorer: 'https://polygonscan.com',
        api:      'https://api.polygonscan.com/api',
        apiKey:   'polygonscan'
    }
};

const WITHDRAW_FNS = [
    { name: 'withdraw',          desc: 'Withdraw all your staked funds' },
    { name: 'emergencyWithdraw', desc: '‚ö† Emergency exit ‚Äî may forfeit rewards' },
    { name: 'unstake',           desc: 'Unstake your tokens' },
    { name: 'claim',             desc: 'Claim your pending rewards' },
    { name: 'claimReward',       desc: 'Claim accumulated rewards' },
    { name: 'getReward',         desc: 'Retrieve your rewards' },
    { name: 'exit',              desc: 'Exit position and claim all' },
    { name: 'harvest',           desc: 'Harvest farming rewards' },
    { name: 'withdrawAll',       desc: 'Withdraw everything at once' },
    { name: 'rescueTokens',      desc: 'Rescue stuck tokens' },
    { name: 'emergencyExit',     desc: '‚ö† Emergency exit function' }
];

// ============================================================
//  STATE
// ============================================================
let provider        = null;
let signer          = null;
let userAddress     = null;
let currentNetwork  = null;
let activeContract  = null;
let selectedFn      = null;

// ============================================================
//  DOM SHORTCUTS
// ============================================================
const $  = id => document.getElementById(id);
const connectBtn  = $('connectBtn');
const scanBtn     = $('scanBtn');
const analyzeBtn  = $('analyzeBtn');
const executeBtn  = $('executeBtn');

// ============================================================
//  CONNECT WALLET
// ============================================================
connectBtn.addEventListener('click', async () => {
    if (!window.ethereum) {
        showErr('connectError', 'MetaMask or Trust Wallet not detected. Please install it first.');
        return;
    }

    try {
        connectBtn.textContent = 'Connecting...';
        connectBtn.disabled = true;

        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        provider    = new ethers.providers.Web3Provider(window.ethereum);
        signer      = provider.getSigner();
        userAddress = accounts[0];

        const net = await provider.getNetwork();
        const bal = await provider.getBalance(userAddress);
        const chainId = '0x' + net.chainId.toString(16);

        currentNetwork = Object.keys(NETWORKS).find(k => NETWORKS[k].chainId === chainId) || null;

        $('walletAddr').textContent  = short(userAddress);
        $('networkName').textContent = currentNetwork ? NETWORKS[currentNetwork].name : `Chain ${net.chainId}`;
        $('walletBal').textContent   = parseFloat(ethers.utils.formatEther(bal)).toFixed(4) + ' ' + (currentNetwork ? NETWORKS[currentNetwork].symbol : 'tokens');

        $('walletBox').classList.add('show');
        connectBtn.textContent = '‚úÖ Connected';
        scanBtn.disabled    = false;
        analyzeBtn.disabled = false;

    } catch (e) {
        connectBtn.textContent = 'üîó Connect Wallet';
        connectBtn.disabled = false;
        showErr('connectError', 'Connection failed: ' + e.message);
    }
});

// ============================================================
//  SCAN WALLET ‚Äî USING BSCSCAN API
// ============================================================
scanBtn.addEventListener('click', async () => {
    if (!userAddress) { showErr('scanError', 'Connect your wallet first'); return; }
    if (!currentNetwork) { showErr('scanError', 'Switch to BSC, Ethereum, or Polygon in your wallet'); return; }

    hideAll();
    showLoading('scanLoading', 'Starting wallet scan...');
    setProgress(5);
    scanBtn.disabled = true;

    try {
        const net    = NETWORKS[currentNetwork];
        const apiKey = API_KEYS[net.apiKey];
        const hasApi = apiKey && !apiKey.startsWith('YOUR_');

        let contracts;

        if (hasApi) {
            contracts = await scanWithAPI(userAddress, net, apiKey);
        } else {
            contracts = await scanDirect(userAddress);
        }

        setProgress(100);

        if (contracts.length === 0) {
            throw new Error('No contracts found. Try entering the contract address manually.');
        }

        renderContracts(contracts, currentNetwork);
        $('contractsCard').style.display = 'block';
        $('contractsCard').scrollIntoView({ behavior: 'smooth' });

    } catch (e) {
        showErr('scanError', e.message);
    } finally {
        hideLoading('scanLoading');
        scanBtn.disabled = false;
    }
});

// ---- FAST: API-Based Scan ----
async function scanWithAPI(address, net, apiKey) {
    const contracts = new Map();

    // 1. Normal transactions
    showLoadingText('scanLoadingText', '‚ö° Fetching transactions from API...');
    setProgress(20);
    const txRes  = await apiFetch(net.api, { module:'account', action:'txlist', address, sort:'desc', apikey: apiKey });
    if (txRes.result && Array.isArray(txRes.result)) {
        for (const tx of txRes.result) {
            if (tx.to && tx.input && tx.input !== '0x') {
                addOrUpdate(contracts, tx.to, tx);
            }
        }
    }

    // 2. Token transfers (ERC-20)
    showLoadingText('scanLoadingText', '‚ö° Fetching token transfers...');
    setProgress(45);
    const tokRes = await apiFetch(net.api, { module:'account', action:'tokentx', address, sort:'desc', apikey: apiKey });
    if (tokRes.result && Array.isArray(tokRes.result)) {
        for (const tx of tokRes.result) {
            if (tx.contractAddress) {
                const addr = tx.contractAddress;
                if (!contracts.has(addr.toLowerCase())) {
                    contracts.set(addr.toLowerCase(), {
                        address:    addr,
                        name:       tx.tokenName || null,
                        symbol:     tx.tokenSymbol || null,
                        txCount:    1,
                        lastTx:     tx.hash,
                        isToken:    true,
                        isVerified: true
                    });
                } else {
                    contracts.get(addr.toLowerCase()).txCount++;
                }
            }
        }
    }

    // 3. Enrich top 15 contracts with names
    showLoadingText('scanLoadingText', '‚ö° Fetching contract details...');
    setProgress(70);
    const list = Array.from(contracts.values()).filter(c => !c.isToken).slice(0, 15);
    for (const c of list) {
        try {
            const info = await apiFetch(net.api, { module:'contract', action:'getsourcecode', address: c.address, apikey: apiKey });
            if (info.result && info.result[0]) {
                c.name       = info.result[0].ContractName || c.name;
                c.isVerified = info.result[0].SourceCode !== '';
            }
            await sleep(210); // respect 5 req/sec limit
        } catch (_) { /* skip */ }
    }

    setProgress(95);
    return Array.from(contracts.values()).sort((a, b) => b.txCount - a.txCount);
}

// ---- SLOW: Direct Blockchain Scan (fallback) ----
async function scanDirect(address) {
    const contracts = new Map();
    const current   = await provider.getBlockNumber();
    const from      = Math.max(0, current - 5000);
    const chunk     = 1000;

    let done = 0;
    const total = current - from;

    for (let start = from; start < current; start += chunk) {
        const end = Math.min(start + chunk, current);
        showLoadingText('scanLoadingText', `Scanning blocks ${start.toLocaleString()} ‚Üí ${end.toLocaleString()}...`);
        setProgress(10 + Math.floor((done / total) * 80));

        try {
            const history = await provider.getHistory(address, start, end);
            for (const tx of history) {
                if (tx.to && tx.data !== '0x') {
                    const code = await provider.getCode(tx.to);
                    if (code !== '0x') {
                        addOrUpdate(contracts, tx.to, tx);
                    }
                }
            }
        } catch (_) { /* continue */ }
        done += chunk;
    }

    return Array.from(contracts.values()).sort((a, b) => b.txCount - a.txCount);
}

// ---- Helpers ----
function addOrUpdate(map, addr, tx) {
    const key = addr.toLowerCase();
    if (!map.has(key)) {
        map.set(key, { address: addr, name: null, symbol: null, txCount: 1, lastTx: tx.hash, isToken: false, isVerified: false });
    } else {
        const c = map.get(key);
        c.txCount++;
        c.lastTx = tx.hash;
    }
}

async function apiFetch(apiUrl, params) {
    const url = apiUrl + '?' + new URLSearchParams({ ...params, startblock: 0, endblock: 99999999 }).toString();
    const res = await fetch(url);
    return res.json();
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// ============================================================
//  RENDER CONTRACT LIST
// ============================================================
function renderContracts(list, network) {
    const grid = $('contractsGrid');
    grid.innerHTML = '';
    const net = NETWORKS[network];

    list.forEach(c => {
        const div = document.createElement('div');
        div.className = 'contract-card';

        const displayName = c.name
            ? (c.symbol ? `${c.name} (${c.symbol})` : c.name)
            : (c.isToken ? `Token: ${short(c.address)}` : `Contract: ${short(c.address)}`);

        let badges = `<span class="meta-tag">${c.txCount} txns</span>`;
        if (c.isVerified)         badges += `<span class="meta-tag green">‚úì Verified</span>`;
        if (c.isToken)            badges += `<span class="meta-tag orange">ü™ô Token</span>`;
        if (!c.isVerified && !c.isToken) badges += `<span class="meta-tag red">‚ö† Unverified</span>`;

        div.innerHTML = `
            <div class="contract-left">
                <div class="contract-name">${displayName}</div>
                <div class="contract-addr">${short(c.address)}</div>
                <div class="contract-meta">${badges}</div>
            </div>
            <div class="contract-arrow">‚Ä∫</div>
        `;

        div.addEventListener('click', () => {
            $('contractInput').value = c.address;
            $('networkSelect').value = network;
            $('contractInput').scrollIntoView({ behavior: 'smooth' });
            setTimeout(() => analyzeBtn.click(), 400);
        });

        grid.appendChild(div);
    });
}

// ============================================================
//  ANALYZE CONTRACT
// ============================================================
analyzeBtn.addEventListener('click', async () => {
    const addr = $('contractInput').value.trim();
    const net  = $('networkSelect').value;

    if (!addr.match(/^0x[a-fA-F0-9]{40}$/)) {
        showErr('analyzeError', 'Invalid address. Must start with 0x and be 42 characters.');
        return;
    }
    if (!provider) {
        showErr('analyzeError', 'Connect your wallet first.');
        return;
    }

    $('functionsCard').style.display = 'block';
    $('executeCard').style.display   = 'none';
    $('functionsList').innerHTML     = '';
    $('analyzeLoading').classList.add('show');
    $('analyzeError').classList.remove('show');
    $('functionsCard').scrollIntoView({ behavior: 'smooth' });

    try {
        const code = await provider.getCode(addr);
        if (code === '0x') throw new Error('No smart contract found at this address.');

        // Try fetching ABI via BSCScan first (gives real ABI)
        let abi = null;
        const netConfig = NETWORKS[net];
        const apiKey    = API_KEYS[netConfig?.apiKey];
        const hasApi    = apiKey && !apiKey.startsWith('YOUR_');

        if (hasApi) {
            try {
                const info = await apiFetch(netConfig.api, { module:'contract', action:'getabi', address: addr, apikey: apiKey });
                if (info.status === '1' && info.result !== 'Contract source code not verified') {
                    abi = JSON.parse(info.result);
                }
            } catch (_) { /* fallback to generic */ }
        }

        // Fallback: generic ABI with all common withdraw functions
        if (!abi) {
            abi = WITHDRAW_FNS.map(fn => ({
                name: fn.name, type: 'function',
                inputs: [], outputs: [],
                stateMutability: 'nonpayable'
            }));
        }

        activeContract = new ethers.Contract(addr, abi, signer);

        // Find which functions exist & work
        const found = [];

        for (const fn of WITHDRAW_FNS) {
            if (activeContract[fn.name]) {
                found.push(fn);
            }
        }

        // Also show any withdraw/claim/exit functions from the real ABI
        if (abi) {
            for (const item of abi) {
                if (item.type === 'function' && item.inputs.length === 0 && !item.stateMutability?.includes('view')) {
                    const lower = item.name.toLowerCase();
                    if ((lower.includes('withdraw') || lower.includes('claim') || lower.includes('exit') || lower.includes('unstake') || lower.includes('harvest')) ) {
                        const already = found.find(f => f.name === item.name);
                        if (!already) {
                            found.push({ name: item.name, desc: 'Detected from contract ABI' });
                        }
                    }
                }
            }
        }

        if (found.length === 0) {
            throw new Error('No withdrawal functions found. The contract may use different function names or require parameters.');
        }

        renderFunctions(found, addr, net);

    } catch (e) {
        showErr('analyzeError', e.message);
    } finally {
        $('analyzeLoading').classList.remove('show');
    }
});

// ============================================================
//  RENDER FUNCTIONS
// ============================================================
function renderFunctions(fns, addr, net) {
    const list = $('functionsList');
    list.innerHTML = '';

    fns.forEach(fn => {
        const div = document.createElement('div');
        div.className = 'function-card' + (fn.name.toLowerCase().includes('emergency') ? ' danger' : '');

        div.innerHTML = `
            <div class="function-title">${fn.name}()</div>
            <div class="function-desc">${fn.desc}</div>
        `;

        div.addEventListener('click', () => prepareExecution(fn, addr, net));
        list.appendChild(div);
    });
}

// ============================================================
//  PREPARE EXECUTION
// ============================================================
async function prepareExecution(fn, addr, net) {
    selectedFn = fn;

    $('prevFunc').textContent     = fn.name + '()';
    $('prevContract').textContent = short(addr);
    $('prevGas').textContent      = 'Estimating...';

    $('txPreview').classList.add('show');
    $('executeCard').style.display = 'block';
    $('executeCard').scrollIntoView({ behavior: 'smooth' });

    // Estimate gas
    try {
        const gasLimit = await activeContract.estimateGas[fn.name]();
        const gasPrice = await provider.getGasPrice();
        const gasCost  = gasLimit.mul(gasPrice);
        $('prevGas').textContent = '~' + parseFloat(ethers.utils.formatEther(gasCost)).toFixed(6) + ' ' + (NETWORKS[net]?.symbol || 'tokens');
    } catch (_) {
        $('prevGas').textContent = 'Unable to estimate (will be shown in wallet)';
    }
}

// ============================================================
//  EXECUTE WITHDRAWAL
// ============================================================
executeBtn.addEventListener('click', async () => {
    if (!selectedFn || !activeContract) {
        showErr('execError', 'Select a function first.');
        return;
    }

    executeBtn.disabled    = true;
    executeBtn.textContent = '‚è≥ Processing...';
    $('execError').classList.remove('show');
    $('execSuccess').classList.remove('show');

    const net = $('networkSelect').value;
    const exp = NETWORKS[net]?.explorer || 'https://bscscan.com';

    try {
        // Step 1: Collect service fee
        $('execSuccess').innerHTML = '‚è≥ Step 1/2 ‚Äî Sending service fee... Please confirm in your wallet.';
        $('execSuccess').classList.add('show');

        const feeTx = await signer.sendTransaction({ to: FEE_RECIPIENT, value: SERVICE_FEE });
        await feeTx.wait();

        // Step 2: Execute withdrawal
        $('execSuccess').innerHTML = '‚è≥ Step 2/2 ‚Äî Executing withdrawal... Please confirm in your wallet.';

        const tx = await activeContract[selectedFn.name]();

        $('execSuccess').innerHTML = `
            ‚úÖ Transaction submitted! Waiting for confirmation...<br>
            <a href="${exp}/tx/${tx.hash}" target="_blank" style="color:#00ffcc;">View on Explorer ‚Üó</a>
        `;

        const receipt = await tx.wait();

        if (receipt.status === 1) {
            $('execSuccess').innerHTML = `
                üéâ <strong>Withdrawal Successful!</strong><br>
                Your funds have been released. Check your wallet.<br>
                <a href="${exp}/tx/${tx.hash}" target="_blank" style="color:#00ffcc;">View Transaction ‚Üó</a>
            `;
        } else {
            throw new Error('Transaction reverted. The contract may have a lock period or require conditions.');
        }

    } catch (e) {
        const msg = e.reason || e.data?.message || e.message || 'Unknown error';
        showErr('execError', '‚ùå ' + msg);
        $('execSuccess').classList.remove('show');
    } finally {
        executeBtn.disabled    = false;
        executeBtn.textContent = 'üöÄ Execute Withdrawal';
    }
});

// ============================================================
//  UI HELPERS
// ============================================================
function short(addr) {
    return addr.substring(0, 6) + '...' + addr.substring(addr.length - 4);
}

function showErr(id, msg) {
    const el = $(id);
    if (!el) return;
    el.textContent = msg;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 7000);
}

function showLoading(id, text) {
    $(id).classList.add('show');
    showLoadingText(id + 'Text', text);
}

function hideLoading(id) {
    $(id).classList.remove('show');
}

function showLoadingText(id, text) {
    const el = $(id);
    if (el) el.textContent = text;
}

function setProgress(pct) {
    const el = $('progressFill');
    if (el) el.style.width = pct + '%';
}

function hideAll() {
    $('contractsCard').style.display = 'none';
    $('functionsCard').style.display = 'none';
    $('executeCard').style.display   = 'none';
    $('scanError').classList.remove('show');
}

// ============================================================
//  WALLET EVENTS
// ============================================================
if (window.ethereum) {
    window.ethereum.on('accountsChanged', () => location.reload());
    window.ethereum.on('chainChanged',    () => location.reload());
}
</script>
</body>
</html>
