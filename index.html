<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø£Ø¯Ø§Ø© Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ø·Ø§Ø±Ø¦ | Emergency Withdraw</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        /* Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ù…Ø³ØªÙˆØ­Ø§Ø© Ù…Ù† ØªØµÙ…ÙŠÙ…Ùƒ */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0f1117;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            text-align: right;
        }
        .container { max-width: 900px; margin: 0 auto; }
        .card { background: #1a1d29; border-radius: 12px; padding: 25px; margin-bottom: 20px; border: 1px solid #2a2d39; }
        h1, h2 { color: #ff4444; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1.1rem; transition: 0.3s; }
        .btn-primary { background: #00ffcc; color: #0f1117; }
        .btn-danger { background: #ff4444; color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .wallet-info { background: #252836; padding: 15px; border-radius: 8px; margin-top: 15px; display: none; }
        .contract-item { background: #252836; padding: 10px; margin: 10px 0; border-right: 4px solid #00ffcc; cursor: pointer; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; background: #0f1117; color: white; border: 1px solid #2a2d39; border-radius: 5px; }
        .loading { display: none; color: #00ffcc; text-align: center; margin: 20px; }
    </style>
</head>
<body>

<div class="container">
    <header style="text-align: center; padding: 20px;">
        <h1>ğŸš¨ Ø£Ø¯Ø§Ø© Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ø·Ø§Ø±Ø¦</h1>
        <p>Ø§Ø³ØªØ±Ø¬Ø¹ Ø£Ù…ÙˆØ§Ù„Ùƒ Ù…Ù† Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ø°ÙƒÙŠØ© Ø­ØªÙ‰ Ù„Ùˆ ØªØ¹Ø·Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø±Ø³Ù…ÙŠ Ù„Ù„Ù…Ø´Ø±ÙˆØ¹.</p>
    </header>

    <div class="card">
        <h2>1. Ø±Ø¨Ø· Ø§Ù„Ù…Ø­ÙØ¸Ø©</h2>
        <button id="connectBtn" class="btn btn-primary">Ø±Ø¨Ø· Ø§Ù„Ù…Ø­ÙØ¸Ø© (MetaMask/Trust)</button>
        <div id="walletInfo" class="wallet-info">
            <p>Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…ØªØµÙ„Ø©: <span id="walletAddress" style="color: #00ffcc;"></span></p>
            <p>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="balance"></span></p>
        </div>
    </div>

    <div class="card">
        <h2>2. Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ø°ÙƒÙŠØ©</h2>
        <button id="scanBtn" class="btn btn-primary" disabled>ğŸ” ÙØ­Øµ Ø§Ù„Ù…Ø­ÙØ¸Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (BSC)</button>
        <div class="loading" id="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ... ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div>
        <div id="contractsList"></div>
    </div>

    <div id="executeSection" class="card" style="display: none;">
        <h2>3. ØªÙ†ÙÙŠØ° Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø³Ø­Ø¨</h2>
        <p style="color: #ffa500;">Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø±Ø³ÙˆÙ… Ø®Ø¯Ù…Ø© Ù‚Ø¯Ø±Ù‡Ø§ 0.005 BNB Ù„Ø¯Ø¹Ù… Ø§Ù„Ø£Ø¯Ø§Ø©.</p>
        <div id="selectedContractInfo"></div>
        <select id="functionSelect">
            <option value="emergencyWithdraw">Emergency Withdraw (Ø³Ø­Ø¨ Ø·Ø§Ø±Ø¦)</option>
            <option value="withdraw">Withdraw (Ø³Ø­Ø¨ Ø¹Ø§Ø¯ÙŠ)</option>
            <option value="claim">Claim (Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø© Ø¨Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª)</option>
            <option value="exit">Exit (Ø®Ø±ÙˆØ¬ Ù†Ù‡Ø§Ø¦ÙŠ)</option>
        </select>
        <button id="executeBtn" class="btn btn-danger">ØªØ£ÙÙŠØ° Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ø¢Ù†</button>
    </div>
</div>

<script>
    // --- Ø§Ù„Ø«ÙˆØ§Ø¨Øª Ø§Ù„ØªÙŠ Ø·Ù„Ø¨ØªÙ‡Ø§ ---
    const FEE_RECIPIENT = "0x52A57ee6711Dbe6453F34C8aF3443db8E86E5094";
    const BSC_API_KEY = "9X7377VVGNKKWX71IZP8C7PARZNSQWAXRB";
    const SERVICE_FEE = ethers.utils.parseEther("0.005");

    const RPC_URLS = {
        eth: "https://eth-mainnet.g.alchemy.com/v2/-nlfxnEP1jvwjMZFHTgZT",
        polygon: "https://polygon-mainnet.g.alchemy.com/v2/-nlfxnEP1jvwjMZFHTgZT",
        bsc: "https://bsc-dataseed.binance.org/"
    };

    let provider, signer, userAddress;

    // Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© ØªØ¹Ø§Ø±Ø¶ Ø§Ù„Ù…Ø­Ø§ÙØ¸ (evmAsk.js)
    function getProvider() {
        if (window.ethereum?.providers?.length) {
            return window.ethereum.providers.find(p => p.isMetaMask) || window.ethereum.providers[0];
        }
        return window.ethereum;
    }

    // Ø±Ø¨Ø· Ø§Ù„Ù…Ø­ÙØ¸Ø©
    document.getElementById('connectBtn').onclick = async () => {
        try {
            const winProvider = getProvider();
            if (!winProvider) return alert("ÙŠØ±Ø¬Ù‰ ØªØ«Ø¨ÙŠØª Ù…Ø­ÙØ¸Ø© ÙƒØ±ÙŠØ¨ØªÙˆ");

            const accounts = await winProvider.request({ method: 'eth_requestAccounts' });
            userAddress = accounts[0];
            provider = new ethers.providers.Web3Provider(winProvider);
            signer = provider.getSigner();

            document.getElementById('walletAddress').innerText = userAddress;
            document.getElementById('walletInfo').style.display = 'block';
            document.getElementById('scanBtn').disabled = false;

            const bal = await provider.getBalance(userAddress);
            document.getElementById('balance').innerText = ethers.utils.formatEther(bal) + " BNB";
        } catch (err) {
            console.error(err);
        }
    };

    // ÙØ­Øµ Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø¹Ø¨Ø± BscScan API
    document.getElementById('scanBtn').onclick = async () => {
        const loading = document.getElementById('loading');
        loading.style.display = 'block';
        const listDiv = document.getElementById('contractsList');
        listDiv.innerHTML = '';

        try {
            const url = `https://api.bscscan.com/api?module=account&action=txlist&address=${userAddress}&startblock=0&endblock=99999999&sort=desc&apikey=${BSC_API_KEY}`;
            const response = await fetch(url);
            const data = await response.json();

            if (data.status === "1") {
                const contracts = [...new Set(data.result.filter(tx => tx.to && tx.input !== '0x').map(tx => tx.to))];
                contracts.slice(0, 10).forEach(addr => {
                    const item = document.createElement('div');
                    item.className = 'contract-item';
                    item.innerText = "Ø¹Ù‚Ø¯ Ù…ÙƒØªØ´Ù: " + addr;
                    item.onclick = () => selectContract(addr);
                    listDiv.appendChild(item);
                });
            } else {
                alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªÙØ§Ø¹Ù„Ø§Øª Ø³Ø§Ø¨Ù‚Ø©.");
            }
        } catch (err) {
            alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ API");
        } finally {
            loading.style.display = 'none';
        }
    };

    let targetContract = "";
    function selectContract(addr) {
        targetContract = addr;
        document.getElementById('executeSection').style.display = 'block';
        document.getElementById('selectedContractInfo').innerHTML = `<p>Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ù…Ø­Ø¯Ø¯: <b>${addr}</b></p>`;
        window.scrollTo(0, document.body.scrollHeight);
    }

    // ØªÙ†ÙÙŠØ° Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø³Ø­Ø¨ Ù…Ø¹ Ø§Ù„Ø±Ø³ÙˆÙ…
    document.getElementById('executeBtn').onclick = async () => {
        const funcName = document.getElementById('functionSelect').value;
        
        try {
            const abi = [`function ${funcName}() public payable`];
            const contractObj = new ethers.Contract(targetContract, abi, signer);

            alert("Ø³ÙŠØªÙ… ÙØªØ­ Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø¢Ù†. Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ØªØªØ¶Ù…Ù† Ø±Ø³ÙˆÙ… Ø§Ù„Ø³Ø­Ø¨ + Ø±Ø³ÙˆÙ… Ø§Ù„Ø®Ø¯Ù…Ø© (0.005 BNB)");

            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚ÙŠÙ…Ø© (Value) Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø®Ø¯Ù…Ø©
            const tx = await contractObj[funcName]({
                value: SERVICE_FEE
            });

            // ØªØ­ÙˆÙŠÙ„ Ø±Ø³ÙˆÙ… Ø§Ù„Ø®Ø¯Ù…Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù„Ù„Ù…Ø³ØªÙ„Ù… ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª (Ø£Ùˆ Ø¹Ø¨Ø± Ø§Ù„Ø¹Ù‚Ø¯ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¯Ø¹ÙˆÙ…Ø§Ù‹)
            // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„ØªØ¨Ø³ÙŠØ· Ø§Ù„ÙƒÙˆØ¯ØŒ Ù‚Ù…Ù†Ø§ Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³ÙˆÙ… Ø§Ù„Ø®Ø¯Ù…Ø© Ù…Ø¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©.
            
            await tx.wait();
            alert("ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­! ØªÙÙ‚Ø¯ Ù…Ø­ÙØ¸ØªÙƒ.");
        } catch (err) {
            console.error(err);
            alert("ÙØ´Ù„Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: " + (err.reason || "Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"));
        }
    };
</script>

</body>
</html>

  
